// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- Enums ---

enum UserRole {
  customer
  organizer

  @@map("user_role")
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELED
}

// --- 1. User Tables ---

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  password     String   @default("temporary_password")
  role         UserRole @default(customer)
  referralCode String?  @unique @map("referral_code")
  avatarUrl    String?  @map("avatar_url")

  // Self-relation untuk Referral System
  referredById String? @map("referred_by_id") @db.Uuid
  referrer     User?   @relation("UserReferrals", fields: [referredById], references: [id])
  referees     User[]  @relation("UserReferrals")

  // Relations ke tabel lain
  points       UserPoint[]
  coupons      UserCoupon[]
  events       Event[]       @relation("OrganizerEvents")
  transactions Transaction[]

  @@map("users")
}

model UserPoint {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  amount    Int      @default(10000)
  isUsed    Boolean  @default(false) @map("is_used")
  expiredAt DateTime @map("expired_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id])

  @@map("user_points")
}

model UserCoupon {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  discountVal Int      @map("discount_val")
  isUsed      Boolean  @default(false) @map("is_used")
  expiredAt   DateTime @map("expired_at") @db.Timestamptz

  user User @relation(fields: [userId], references: [id])

  @@map("user_coupons")
}

// --- 2. Event & Promotion Tables ---

model Event {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizerId     String   @map("organizer_id") @db.Uuid
  name            String
  
  // Tambahkan di sini
  description     String?  @db.Text
  location        String   @default("TBA") // Tempat acara (misal: "Jakarta Convention Center")
  venue           String   @default("TBA")
  imageUrl        String?  // Path file foto banner
  
  price           Decimal  @db.Decimal(12, 2)
  totalSeats      Int      @map("total_seats")
  availableSeats  Int      @map("available_seats")
  startDate       DateTime @map("start_date") @db.Timestamptz
  endDate         DateTime @map("end_date") @db.Timestamptz

  // Relations
  organizer    User           @relation("OrganizerEvents", fields: [organizerId], references: [id])
  vouchers     EventVoucher[]
  transactions Transaction[]

  @@map("events")
}

model EventVoucher {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventId        String   @map("event_id") @db.Uuid
  code           String   @unique
  discountAmount Decimal  @map("discount_amount") @db.Decimal(12, 2)
  maxUses        Int      @map("max_uses")
  expiryDate     DateTime @map("expiry_date") @db.Timestamptz

  event Event @relation(fields: [eventId], references: [id])

  @@map("event_vouchers")
}

// --- 3. Transaction & Payment Tables ---

model Transaction {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId String @map("customer_id") @db.Uuid
  eventId    String @map("event_id") @db.Uuid

  totalPrice Decimal           @map("total_price") @db.Decimal(12, 2)
  status     TransactionStatus @default(WAITING_PAYMENT)

  paymentProofUrl String?  @map("payment_proof_url")
  expiresAt       DateTime @map("expires_at") @db.Timestamptz

  // Relations
  customer User    @relation(fields: [customerId], references: [id])
  event    Event   @relation(fields: [eventId], references: [id])
  review   Review?

  @@map("transactions")
}

model Review {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  transactionId String @unique @map("transaction_id") @db.Uuid

  rating  Int
  comment String?

  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@map("reviews")
}